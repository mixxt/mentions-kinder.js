/*! mentions-kinder.js - v0.3.3 - 2016-08-24
* https://github.com/mixxt/mentions-kinder.js
* Copyright (c) 2016 mixxt GmbH; Licensed MIT */
!function(a){function b(a,b){return a?Object.prototype.hasOwnProperty.call(a,b):!1}(function(){var b=function(a,b){return function(){return a.apply(b,arguments)}};this.MentionsKinder=function(){function c(a,c){this.handleDelete=b(this.handleDelete,this),this.handlePlaceholder=b(this.handlePlaceholder,this),this.handleReset=b(this.handleReset,this),this.handlePaste=b(this.handlePaste,this),this.handleKeyup=b(this.handleKeyup,this),this.handleInput=b(this.handleInput,this),this.handleAutocompleteFail=b(this.handleAutocompleteFail,this),this.handleAutocompleteDone=b(this.handleAutocompleteDone,this),this.focus=b(this.focus,this),this.cleanEditable=b(this.cleanEditable,this),this.deserializeFromInput=b(this.deserializeFromInput,this),this.populateInput=b(this.populateInput,this),this._ensureInput(a),this._buildOptions(c),this._setupElements(),this._setupEvents(),this.$editable.attr("autofocus")&&this.$editable.focus()}var d,e,f;return d={RETURN:13,ESC:27},e=3,c.prototype.defaultOptions={trigger:{"@":{triggerName:"member"}},deserialize:function(a,b,c,d,e){var f,g;return f=null!=(g=this.options.trigger[b])?g.formatter:void 0,f?f({trigger:b,name:c,value:e,triggerOptions:{triggerName:d},serializedMention:a}).get(0):document.createTextNode(a)},deserializeRegex:/\[(.)(.+?)\]\((\w+):(.+?)\)/g},c.prototype.triggerDefaultOptions={autocompleter:c.Autocompleter,formatter:function(b){var c,d,e,f;return e=a("<span class='"+b.triggerOptions.triggerName+"-trigger'></span>").text(b.trigger),f=a("<span class='"+b.triggerOptions.triggerName+"-value'></span>").text(b.name),d=a('<span class="mention label" contenteditable="false"></span>'),c=a("<span class='delete-mention "+b.triggerOptions.triggerName+"-delete'><i class='icon-remove'></i></span>"),d.append([e,f,c]),d.attr("serialized-mention",b.serializedMention),d},serializer:function(a){return"["+a.trigger+a.name+"]("+a.triggerOptions.triggerName+":"+a.value+")"}},c.prototype.populateInput=function(){var a;return a=this.serializeEditable(),this.$originalInput.val(a).trigger({type:"change",mentionsKinder:!0}),this.$originalInput.trigger("mentions-kinder-change",a)},c.prototype.serializeEditable=function(){return this.serializeNode(this.$editable[0])},c.prototype.deserializeFromInput=function(){return this.$editable.html(this._deserialize(this.$originalInput.val()))},c.prototype.cleanEditable=function(){return this._cleanChildNodes(this.$editable[0])},c.prototype.focus=function(){return this.$editable.focus()},c.prototype.startAutocomplete=function(b){var c;return this._current={trigger:b,triggerOptions:this.trigger[b],$tempMention:a("<span class='mention temp-mention label'>"+b+"</span>")},c=this._current.$tempMention.get(0),this._insertNode(c),this._current.autocompleter=new this._current.triggerOptions.autocompleter({mentionsKind:this}),this._current.autocompleter.done(this.handleAutocompleteDone),this._current.autocompleter.fail(this.handleAutocompleteFail),this._current.autocompleter.always(this.populateInput),this._current.autocompleter.search("")},c.prototype.updateAutocomplete=function(){var a,b;return a=this._current.$tempMention.text(),b=this._current.trigger.length,a.slice(0,b)===this._current.trigger?this._current.autocompleter.search(a.slice(b)):this.abortAutocomplete()},c.prototype.isAutocompleting=function(){return null!=this._current?a.contains(this.$editable,this._current.$tempMention)?!0:(this._current.autocompleter.abort(),this._current=null,!1):!1},c.prototype.abortAutocomplete=function(){return this.isAutocompleting()&&this._current.autocompleter.abort()},c.prototype.handleAutocompleteDone=function(b){var c,d;return b=a.extend({},this._current,b),b.serializedMention=this._current.triggerOptions.serializer(b),c=this._current.triggerOptions.formatter(b),d=document.createTextNode(String.fromCharCode(160)),a(d).insertAfter(this._current.$tempMention),this.$editable.focus(),this._setCaretToEndOf(d),this._current.$tempMention.replaceWith(c),this._current=null},c.prototype.handleAutocompleteFail=function(){var a;return a=document.createTextNode(this._current.$tempMention.text()),this._current.$tempMention.replaceWith(a),this._setCaretToEndOf(a),this._current=null},c.prototype.handleInput=function(a){var b,c;return c=a.charCode||a.which||a.keyCode,b=String.fromCharCode(c),!this.isAutocompleting()&&this.trigger[b]&&(a.preventDefault(),this.startAutocomplete(b)),c===d.RETURN&&!this.multiline&&(a.preventDefault(),this.submitOnEnter)?this.$form.submit():void 0},c.prototype.handleKeyup=function(a){switch(this.isAutocompleting()&&this.updateAutocomplete(),a.keyCode){case d.ESC:this.abortAutocomplete()}return this.isAutocompleting()&&!this._isCaretInTempMention()&&this.abortAutocomplete(),this.populateInput()},c.prototype.handlePaste=function(a){var b;return(b=this._getClipboardContent(a))?(a.preventDefault(),this._insertText(b)):setTimeout(this.cleanEditable,0),setTimeout(this.populateInput,0)},c.prototype.handleReset=function(){var a=this;return this.$editable.empty().blur(),setTimeout(function(){return a.deserializeFromInput(),a.handlePlaceholder()},0)},c.prototype.handlePlaceholder=function(a){var b=this;if(null!=this.$placeholder)if("focus"===(null!=a?a.type:void 0)){if(!this.placeholderDetached)return this.placeholderDetached=!0,window.setTimeout(function(){return b.$placeholder.detach()})}else if(""===this.serializeEditable())return this.$editable.empty().append(this.$placeholder),this.placeholderDetached=!1},c.prototype.handleDelete=function(b){var c,d;return b.preventDefault(),c=a(b.target).parents(".mention"),c?(d=c.get(0).nextSibling,d&&this._setCaretToStartOf(d),c.remove(),this.populateInput()):void 0},c.prototype._ensureInput=function(b){return this.$originalInput=a(b),this.$originalInput.is("input[type=text],textarea")||a.error("$.mentionsKinder works only on input[type=text] or textareas, was "+(b&&b.tagName)),this.multiline=this.$originalInput.is("textarea")},c.prototype._buildOptions=function(b){var c=this;return this.options=a.extend({},this.defaultOptions,b),a.each(this.options.trigger,function(b,d){return c.options.trigger[b]=a.extend({},c.triggerDefaultOptions,d)}),this.trigger=this.options.trigger||{}},c.prototype._setupElements=function(){var b,c;return this.$wrap=a('<div class="mentions-kinder-wrap"></div>'),this.$editable=a('<div class="form-control mentions-kinder" contenteditable="true"></div>'),this.$editable.addClass("mentions-kinder-"+(this.multiline?"multiline":"singleline")),this.$editable.addClass(this.$originalInput.attr("class")),(b=this.$originalInput.attr("autofocus"))&&this.$editable.attr("autofocus",b),""!==this.$originalInput.val()&&this.deserializeFromInput(),(c=this.$originalInput.attr("placeholder"))&&(this.$placeholder=a("<span class='placeholder'>"+c+"</span>"),this.handlePlaceholder()),this.$wrap.insertAfter(this.$originalInput),this.$originalInput.appendTo(this.$wrap).addClass("mentions-kinder-hidden"),this.$editable.appendTo(this.$wrap),void 0},c.prototype._setupEvents=function(){var b,c=this;return this.$editable.bind("keypress",this.handleInput),this.$editable.bind("keyup",this.handleKeyup),this.$editable.bind("paste",this.handlePaste),this.$editable.bind("focus blur",this.handlePlaceholder),this.$editable.on("click",".delete-mention",this.handleDelete),this.$originalInput.on("focus",this.focus),this.$originalInput.on("change",function(a){return a.mentionsKinder?void 0:c.deserializeFromInput()}),(b=this.$originalInput.get(0).form)?(this.$form=a(b),this.multiline||(this.submitOnEnter=!0),this.$form.on("reset",this.handleReset)):void 0},c.prototype._getClipboardContent=function(a){var b,c;return(null!=(b=a.originalEvent)?b.clipboardData:void 0)?a.originalEvent.clipboardData.getData("text/plain"):(null!=(c=window.clipboardData)?c.getData:void 0)?window.clipboardData.getData("Text"):void 0},c.prototype._getRange=function(a){var b,c;return c=rangy.getSelection(),b=c.getRangeAt(0),c.setSingleRange(b),a(b,c)},c.prototype._insertNode=function(a){return this._getRange(function(b,c){return b.insertNode(a),b.selectNodeContents(a),c.collapseToEnd()})},c.prototype._insertText=function(a){var b,c,d,e,f;for(c=a.split("\n"),d=[],e=0,f=c.length;f>e;e++)b=c[e],d.push(document.createTextNode(b)),d.push(document.createElement("BR"));return d.pop(),this._getRange(function(a,b){var c,e,f,g;for(a.deleteContents(),e=d.reverse(),f=0,g=e.length;g>f;f++)c=e[f],a.insertNode(c);return a.selectNodeContents(e[0]),b.collapseToEnd()}),void 0},f=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b);return e},c.prototype._cleanChildNodes=function(a){var b,c,d,e;for(e=f(a.childNodes),c=0,d=e.length;d>c;c++)b=e[c],this._cleanNode(b);return!0},c.prototype._cleanNode=function(b){var c;return b.nodeType===e||("BR"===b.nodeName.toUpperCase()?this.multiline||a(b).replaceWith(" "):a(b).attr("serialized-mention")?a(b).attr("contenteditable",!1):(null!=(c=b.childNodes)?c.length:void 0)>0?(this._cleanChildNodes(b),a(b).replaceWith(b.childNodes)):a(b).remove()),!0},c.prototype.serializeNode=function(a){return this._trim(this._tokenizeNode(a).join("")).replace(/\u00A0/g," ")},c.prototype._tokenizeNode=function(b){var c,d,f,g,h,i;for(f=[],i=b.childNodes,g=0,h=i.length;h>g;g++)c=i[g],c.nodeType===e?f.push(c.data):"BR"===c.nodeName.toUpperCase()?this._isLastChildNode(c)||f.push("\n"):(d=a(c).attr("serialized-mention"))?f.push(d):"P"===c.nodeName.toUpperCase()||"DIV"===c.nodeName.toUpperCase()?(this._previousNodeIsTextNode(c)&&f.push("\n"),f=f.concat(this._tokenizeNode(c)),this._isLastChildNode(c)||f.push("\n")):f=f.concat(this._tokenizeNode(c));return f},c.prototype._isLastChildNode=function(a){return a.parentNode.lastChild===a},c.prototype._previousNodeIsTextNode=function(a){var b;return(null!=(b=a.previousSibling)?b.nodeType:void 0)===e},c.prototype._deserialize=function(a){var b,c,d,e,f;for(f=[],e=this.options.deserializeRegex,d=0;;){if(c=e.exec(a),!c){d!==a.length&&(b=a.substring(d,a.length),""!==b&&this._deserializeText.call(f,b));break}0!==c.index&&this._deserializeText.call(f,a.substring(d,c.index)),d=e.lastIndex,f.push(this.options.deserialize.apply(this,c))}return f},c.prototype._deserializeText=function(a){var b,c,d,e,f,g;for(d=a.split("\n"),g=[],b=e=0,f=d.length;f>e;b=++e)c=d[b],this.push(document.createTextNode(c)),b!==d.length-1?g.push(this.push(document.createElement("br"))):g.push(void 0);return g},c.prototype._prepareSetCaretTo=function(a){var b,c;return c=rangy.getSelection(),b=c.getRangeAt(0),b.selectNodeContents(a),c.setSingleRange(b),c},c.prototype._setCaretToEndOf=function(a){return this._prepareSetCaretTo(a).collapseToEnd()},c.prototype._setCaretToStartOf=function(a){return this._prepareSetCaretTo(a).collapseToStart()},c.prototype._isCaretInTempMention=function(){var a;return this.isAutocompleting()?(a=rangy.getSelection().getRangeAt(0),(null!=a?a.compareNode(this._current.$tempMention.get(0)):void 0)===a.NODE_BEFORE_AND_AFTER):void 0},c.prototype._trim=function(b){return a.trim(b)},c}()}).call(this),function(){MentionsKinder.Autocompleter=function(){function b(b){null==b&&(b={}),this.mentionsKind=b.mentionsKind,this.options=b,this.initialize(),this.deferred=a.Deferred(),this.deferred.promise(this)}return b.prototype.initialize=function(){},b.prototype.complete=function(a){return this.deferred.resolve(a)},b.prototype.abort=function(){return this.deferred.reject()},b.prototype.search=function(){return a.error("implement #search in your autocompleter")},b}()}.call(this);var c=function(c,d){var e,f=this;e=c&&b(c,"constructor")?c.constructor:function(){return f.apply(this,arguments)},a.extend(e,f,d);var g=function(){this.constructor=e};return g.prototype=f.prototype,e.prototype=new g,c&&a.extend(e.prototype,c),e.__super__=f.prototype,e};MentionsKinder.extend=MentionsKinder.Autocompleter.extend=c,function(){MentionsKinder.Autocompleter.Select2Autocompleter=MentionsKinder.Autocompleter.extend({select2Options:{data:[]},initialize:function(){var b=this;return this._setupInput(),this.$input.on("select2-selecting",function(c){var d;return d=a.extend({},{name:c.object.text,value:c.object.id},c.object),b.complete.call(b,d),b.$input.select2("destroy").remove()}),this.$input.on("select2-close",function(){return b.abort.call(b),b.$input.select2("destroy").remove()})},search:a.noop,_setupInput:function(){return this.$input=a('<input type="hidden" />').css("width",this.mentionsKind.$editable.width()).appendTo(this.mentionsKind.$wrap),this.$input.select2(this.select2Options),this.$input.select2("open")}}),MentionsKinder.prototype.triggerDefaultOptions.autocompleter=MentionsKinder.Autocompleter.Select2Autocompleter}.call(this),function(){a.fn.mentionsKinder=function(b){return this.each(function(){var c;return c=a(this).data("mentionsKinder"),void 0===c?a(this).data("mentionsKinder",new a.MentionsKinder(this,b)):void 0})},a.MentionsKinder=MentionsKinder,a.MentionsKinder.defaultOptions=MentionsKinder.prototype.defaultOptions,a.MentionsKinder.triggerDefaultOptions=MentionsKinder.prototype.triggerDefaultOptions}.call(this)}(jQuery);